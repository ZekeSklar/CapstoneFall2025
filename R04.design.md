## Design — Berea College Printing Services

### Architecture Overview
- Web framework: Django 5.2 (Python 3.11); single app `tickets` inside `codebase/` project.
- Database: SQLite (dev). Models via migrations.
- Email: SMTP settings from `.env` (python‑dotenv)
- SNMP: `pysnmp` asyncio client module with v2c→v1 fallback.

### Data Model (key entities)
- `Printer`: campus_label, asset_tag, make/model, building/location, ip_address, mac_address, group, qr_token, is_active.
- `PrinterGroup`: name, building; M2M managers; has many printers.
- `PrinterStatus`: 1‑to‑1 with `Printer`; fields: status_code/label, device_status_code/label, error_state_raw, error_flags[], alerts[], supplies[], snmp_ok/message, attention, fetched_at/updated_at.
- `RequestTicket`: type (supply/issue), status, printer/group, requester fields, details, created_at.
- `IssueSummaryState`: tracks last digest send time.
- `IssueSummaryRecipient`: 1‑to‑1 with `User` (superuser opt‑in toggle).

### SNMP Client (`tickets/snmp_client.py`)
- Asyncio HLAPI; handles both async‑iterator and coroutine return types.
- Tries `UdpTransportTarget.create()` then falls back to constructor as needed.
- v2c→v1 fallback for compatibility.
- OIDs read (when present):
  - `hrPrinterStatus` 1.3.6.1.2.1.25.3.5.1.1
  - `hrPrinterDetectedErrorState` 1.3.6.1.2.1.25.3.5.1.2
  - `hrDeviceStatus` 1.3.6.1.2.1.25.3.2.1.5
  - `prtAlertTable` 1.3.6.1.2.1.43.18.1.1
  - `prtConsoleDisplayBuffer` 1.3.6.1.2.1.43.16.5.1.2
  - `prtMarkerSuppliesTable` 1.3.6.1.2.1.43.11.1.1
- Builds a snapshot: status/device, error flags (bit decode), alerts (with severity), supplies (percent when possible), console lines.

### Status Service (`tickets/printer_status.py`)
- `ensure_latest_status(printer, force=False)`
  - Returns cached `PrinterStatus` unless stale by `SNMP_POLL_INTERVAL_SECONDS`.
  - On refresh, calls SNMP client; applies snapshot or failure state; sets `attention`.
- `build_status_payload(printer, status)` → stable JSON for UI.

### Views and Endpoints (`tickets/views.py`)
- JSON feeds
  - `manager_status_feed` (login required): returns list of status payloads for managed printers; `?printer=` for single; `?force=1` to bypass cache. Sends `Cache-Control: no-store`.
  - `manager_printer_status` (login required): same shape as above for a specific id.
- Tickets
  - Forms for supplies/issues; email on submit.
  - Rate limiting: counts issue tickets for a printer within a 1‑hour window; accepts up to 3.

### Admin (`tickets/admin.py` + templates)
- Printer change form injects Live Device Status panel; initial payload and Refresh endpoint URL.
- Admin index shows “Printer Device Alerts” (attention/SNMP faults) and low inventory.
- CSV export actions for printers and tickets.

### Middleware and Email Digest
- `IssueSummaryMiddleware` triggers a once‑per‑interval send on first request past the window.
- `tickets/summary.py` composes the digest and resolves recipients from `.env` and subscribed superusers.
- Management command `send_issue_summary` allows manual triggering.

### Front‑end Behavior
- Admin/Manager pages use small scripts to render payloads and refresh on demand.
- 5‑minute auto refresh on dashboard; cache‑busting `t=Date.now()` param on fetch.

### Security and Permissions
- Admin pages restricted to staff/superusers.
- Manager dashboard checks membership to printer groups.
- Public QR portal limited to submission; no status exposure.

### Error Handling
- SNMP timeouts/errors marked as `snmp_ok=False` with `snmp_message` and `attention=True` when appropriate.
- UI displays “Unavailable” or the last known good state; avoids crashing server threads.

